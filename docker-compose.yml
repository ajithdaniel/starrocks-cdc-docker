# =============================================================================
# StarRocks CDC Pipeline - Shared-Data Mode
# =============================================================================
# Architecture:
#   MySQL (Source) --> Flink CDC --> StarRocks (Shared-Data with MinIO)
#
# Components:
#   - MySQL 8.0: Source database with binlog enabled
#   - MinIO: S3-compatible object storage for StarRocks shared-data
#   - StarRocks FE: Frontend node (metadata, query planning)
#   - StarRocks CN: Compute Node (stateless, queries object storage)
#   - Flink: Stream processing for CDC
#   - Flink CDC: Change Data Capture pipeline
# =============================================================================

services:
  # ===========================================================================
  # MinIO - Object Storage for StarRocks Shared-Data Mode
  # ===========================================================================
  minio:
    image: minio/minio:RELEASE.2024-11-07T00-52-20Z
    container_name: minio
    hostname: minio
    restart: unless-stopped
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    networks:
      - starrocks-net

  # MinIO Client - Create bucket on startup
  minio-init:
    image: minio/mc:RELEASE.2024-11-05T11-29-45Z
    container_name: minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin minioadmin123;
      mc mb myminio/starrocks --ignore-existing;
      mc anonymous set public myminio/starrocks;
      echo 'MinIO bucket created successfully';
      exit 0;
      "
    networks:
      - starrocks-net

  # ===========================================================================
  # MySQL - Source Database with CDC enabled
  # ===========================================================================
  mysql:
    image: mysql:8.0
    container_name: mysql-source
    hostname: mysql
    restart: unless-stopped
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root123
      MYSQL_DATABASE: source_db
      MYSQL_USER: cdc_user
      MYSQL_PASSWORD: cdc_pass123
    command:
      - --server-id=1
      - --log-bin=mysql-bin
      - --binlog-format=ROW
      - --binlog-row-image=FULL
      - --gtid-mode=ON
      - --enforce-gtid-consistency=ON
      - --max-binlog-size=100M
      - --expire-logs-days=3
    volumes:
      - mysql_data:/var/lib/mysql
      - ./scripts/mysql-init.sql:/docker-entrypoint-initdb.d/01-init.sql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-proot123"]
      interval: 10s
      timeout: 5s
      retries: 10
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    networks:
      - starrocks-net

  # ===========================================================================
  # StarRocks Frontend (FE) - Shared-Data Mode
  # ===========================================================================
  starrocks-fe:
    image: starrocks/fe-ubuntu:3.3.0
    container_name: starrocks-fe
    hostname: starrocks-fe
    restart: unless-stopped
    ports:
      - "8030:8030"   # HTTP port
      - "9030:9030"   # MySQL protocol port
    environment:
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin123
    command: >
      bash -c "/opt/starrocks/fe/bin/start_fe.sh --host_type FQDN && tail -f /opt/starrocks/fe/log/fe.log"
    volumes:
      - ./config/fe.conf:/opt/starrocks/fe/conf/fe.conf
      - fe_meta:/opt/starrocks/fe/meta
      - fe_log:/opt/starrocks/fe/log
    depends_on:
      minio-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8030/api/health"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G
    networks:
      - starrocks-net

  # ===========================================================================
  # StarRocks Compute Node (CN) - Stateless for Shared-Data Mode
  # ===========================================================================
  starrocks-cn:
    image: starrocks/cn-ubuntu:3.3.0
    container_name: starrocks-cn
    hostname: starrocks-cn
    restart: unless-stopped
    ports:
      - "8040:8040"   # BE HTTP port
    environment:
      - AWS_ACCESS_KEY_ID=minioadmin
      - AWS_SECRET_ACCESS_KEY=minioadmin123
    command: >
      bash -c "/opt/starrocks/cn/bin/start_cn.sh && tail -f /opt/starrocks/cn/log/cn.log"
    volumes:
      - ./config/cn.conf:/opt/starrocks/cn/conf/cn.conf
      - cn_data:/opt/starrocks/cn/storage
      - cn_log:/opt/starrocks/cn/log
    depends_on:
      starrocks-fe:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8040/api/health"]
      interval: 15s
      timeout: 10s
      retries: 20
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G
    networks:
      - starrocks-net

  # ===========================================================================
  # Flink JobManager - For CDC Processing
  # ===========================================================================
  flink-jobmanager:
    image: flink:1.20-java17
    container_name: flink-jobmanager
    hostname: flink-jobmanager
    restart: unless-stopped
    ports:
      - "8081:8081"
    command: jobmanager
    environment:
      - JDK_JAVA_OPTIONS=--add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
        execution.checkpointing.interval: 10000
        state.backend: hashmap
        state.checkpoints.dir: file:///opt/flink/checkpoints
        parallelism.default: 2
        env.java.opts.all: -XX:+IgnoreUnrecognizedVMOptions
    volumes:
      - ./flink-cdc:/opt/flink-cdc
      - ./flink-cdc/lib:/opt/flink/lib/cdc
      - flink_checkpoints:/opt/flink/checkpoints
    depends_on:
      starrocks-cn:
        condition: service_healthy
      mysql:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G
    networks:
      - starrocks-net

  # ===========================================================================
  # Flink TaskManager - Worker Node
  # ===========================================================================
  flink-taskmanager:
    image: flink:1.20-java17
    container_name: flink-taskmanager
    hostname: flink-taskmanager
    restart: unless-stopped
    command: taskmanager
    environment:
      - JDK_JAVA_OPTIONS=--add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
        taskmanager.numberOfTaskSlots: 12
        execution.checkpointing.interval: 10000
        env.java.opts.all: -XX:+IgnoreUnrecognizedVMOptions
    volumes:
      - ./flink-cdc:/opt/flink-cdc
      - ./flink-cdc/lib:/opt/flink/lib/cdc
      - flink_checkpoints:/opt/flink/checkpoints
    depends_on:
      - flink-jobmanager
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    networks:
      - starrocks-net

  # ===========================================================================
  # CDC Setup Runner - Initializes StarRocks tables and starts CDC
  # ===========================================================================
  cdc-setup:
    image: flink:1.20-java17
    container_name: cdc-setup
    hostname: cdc-setup
    environment:
      - JDK_JAVA_OPTIONS=--add-opens=java.base/java.lang=ALL-UNNAMED --add-opens=java.base/java.util=ALL-UNNAMED
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: flink-jobmanager
        env.java.opts.all: -XX:+IgnoreUnrecognizedVMOptions
    volumes:
      - ./scripts:/sql
      - ./flink-cdc:/opt/flink-cdc
      - ./flink-cdc/lib:/opt/flink/lib/cdc
    depends_on:
      starrocks-cn:
        condition: service_healthy
      mysql:
        condition: service_healthy
      flink-jobmanager:
        condition: service_started
    entrypoint: ["/bin/bash", "/opt/flink-cdc/setup-cdc.sh"]
    networks:
      - starrocks-net

# =============================================================================
# Networks
# =============================================================================
networks:
  starrocks-net:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  minio_data:
  mysql_data:
  fe_meta:
  fe_log:
  cn_data:
  cn_log:
  flink_checkpoints:
